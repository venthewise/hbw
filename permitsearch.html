<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PermitPro - Batch Permit Search</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      color: #1976d2;
      text-decoration: none;
    }
    .nav {
      display: flex;
      gap: 2rem;
    }
    .nav a {
      color: #666;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
    }
    .nav a:hover {
      color: #1976d2;
    }
    .main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .container {
      background: white;
      padding: 3rem;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 600px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .footer {
      background: #1976d2;
      color: white;
      padding: 2rem 0;
      margin-top: auto;
    }
    .footer-content {
      max-width: 1200px;
      color: white;
      margin: 0 auto;
      padding: 0 2rem;
      text-align: center;
    }
    .footer p {
      margin-bottom: 0.5rem;
      color: white !important;
    }
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 1rem;
    }
    .footer-links a {
      color: #bbdefb;
      text-decoration: none;
      font-weight: 500;
    }
    .footer-links a:hover {
      color: white;
    }
    h1 {
      color: #1976d2;
      margin-bottom: 1.5rem;
      font-weight: 500;
      font-size: 2.2rem;
    }
    textarea {
      font-family: 'Roboto', sans-serif;
      font-size: 14px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      width: 100%;
      min-height: 200px;
      border: 2px solid #e3f2fd;
      border-radius: 8px;
      resize: vertical;
      transition: border-color 0.3s;
    }
    textarea:focus {
      outline: none;
      border-color: #1976d2;
    }
    button {
      font-family: 'Roboto', sans-serif;
      font-size: 16px;
      font-weight: 500;
      padding: 12px 24px;
      color: white;
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
    }
    button:disabled {
      background: #90caf9;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    p {
      color: #666;
      margin-bottom: 1rem;
    }
    #status {
      margin-top: 1.5rem;
      font-size: 14px;
      color: #666;
      min-height: 20px;
    }
    #error {
      color: #d32f2f;
      margin-bottom: 1rem;
      font-size: 14px;
      background: #ffebee;
      padding: 0.5rem;
      border-radius: 4px;
      border-left: 4px solid #d32f2f;
    }
    .toggle-container {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
      font-size: 14px;
      color: #666;
    }
    .toggle-container input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
      accent-color: #1976d2;
    }
    .location-selector {
      margin-bottom: 1.5rem;
      text-align: left;
    }
    .location-selector label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #333;
    }
    .location-selector select {
      padding: 10px 12px;
      border: 2px solid #e3f2fd;
      border-radius: 8px;
      font-size: 14px;
      background-color: white;
      width: 100%;
      transition: border-color 0.3s;
    }
    .location-selector select:focus {
      outline: none;
      border-color: #1976d2;
    }
    .quick-guide {
      text-align: left;
      margin-bottom: 1.5rem;
      font-size: 14px;
      color: #666;
      background: #f8f9fa;
      padding: 2rem;
      border-radius: 8px;
      border-left: 4px solid #1976d2;
    }
    .quick-guide ol {
      margin-top: 0.5rem;
    }
    .quick-guide li {
      margin-bottom: 0.25rem;
    }
    #status.processing {
      font-size: 18px;
      font-weight: 500;
      color: #1976d2;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .spinner {
      border: 3px solid rgba(25, 118, 210, 0.2);
      border-top: 3px solid #1976d2;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #downloadBtn {
      margin-top: 1rem;
      background: #4caf50 !important;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3) !important;
    }
    #downloadBtn:hover {
      background: #388e3c !important;
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4) !important;
    }
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }
      .nav {
        gap: 1rem;
      }
      .container {
        padding: 2rem;
        margin: 1rem;
      }
      h1 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="#" class="logo">HBW Permit Reports</a>
      <nav class="nav">
        <a href="#features">Features</a>
        <a href="#pricing">Pricing</a>
        <a href="#support">Support</a>
        <a href="#contact">Contact</a>
      </nav>
    </div>
  </header>

  <main class="main">
    <div class="container">
      <h1>Batch Permit Search</h1>
    <div class="location-selector">
      <label for="locationSelect">Select Location:</label>
      <select id="locationSelect">
        <option value="clearwater">Clearwater</option>
        <option value="northport">Northport</option>
        <option value="pasco">Pasco</option>
        <option value="tampa">Tampa</option>
        <option value="bradenton">Bradenton</option>
        <option value="hillsborough">Hillsborough</option>
        <option value="polkcounty">Polk County</option>
        <option value="charlotte">Charlotte</option>
        <option value="atlanta">Atlanta</option>
        <option value="citruscounty">Citrus County</option>
        <option value="fortworth">Fort Worth</option>
        <option value="lakealfred">Lake Alfred</option>
        <option value="leoncounty">Leon County</option>
        <option value="sanantonio">San Antonio</option>
        <option value="sarasota">Sarasota</option>
        <option value="weston">Weston</option>
      </select>
    </div>
    <div class="toggle-container">
      <input type="checkbox" id="autoDownloadToggle" checked>
      <label for="autoDownloadToggle">Auto-download CSV file</label>
    </div>
    <p>Paste permit numbers below, one per line.</p>

    <div id="error"></div>

    <form id="permitForm">
      <textarea id="permitNumbersInput" name="permitNumbers"
        placeholder="BCP2025-090576&#10;BCP2025-090623&#10;..." required></textarea>
      <div class="quick-guide">
        <strong>Quick Guide:</strong>
        <ol>
          <li>Enter one permit number per line.</li>
          <li>Recommended to paste up to 20 permit numbers at a time.</li>
          <li>Click "Generate CSV Report" to submit the permits.</li>
          <li>Once processing is complete, permit report will be auto-downloaded if auto-download is checked.<br>
          Or click on Download CSV to save your report if auto-download is unchecked.</li>
        </ol>
      </div>
      <button type="submit">Generate CSV Report</button>
    </form>

      <div id="status"></div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer-content">
      <p>2025 HBW Permit Reports. All rights reserved.</p>
      <!-- <div class="footer-links">
        <a href="#privacy">Privacy Policy</a>
        <a href="#terms">Terms of Service</a>
        <a href="#support">Support</a>
      </div> -->
    </div>
  </footer>

  <script>

    const form = document.getElementById('permitForm');
    const textarea = document.getElementById('permitNumbersInput');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const locationSelect = document.getElementById('locationSelect');
    const autoDownloadToggle = document.getElementById('autoDownloadToggle');
    const submitBtn = form.querySelector('button[type="submit"]');

    // Webhook URLs for different locations
    const webhookURLs = {
      clearwater: 'https://n8n.ai8mations.com/webhook/cwater',
      northport: 'https://n8n.ai8mations.com/webhook/northport',
      pasco: 'https://n8n.ai8mations.com/webhook/pasco',
      tampa: 'https://n8n.ai8mations.com/webhook/tampa',
      bradenton: 'https://n8n.ai8mations.com/webhook/bradenton',
      hillsborough: 'https://n8n.ai8mations.com/webhook/hillsborough',
      polkcounty: 'https://n8n.ai8mations.com/webhook/polkcounty',
      charlotte: 'https://n8n.ai8mations.com/webhook/charlotte',
      atlanta: 'https://n8n.ai8mations.com/webhook/atlanta',
      citruscounty: 'https://n8n.ai8mations.com/webhook/citruscounty',
      fortworth: 'https://n8n.ai8mations.com/webhook/fortworth',
      lakealfred: 'https://n8n.ai8mations.com/webhook/lakealfred',
      leoncounty: 'https://n8n.ai8mations.com/webhook/leoncounty',
      sanantonio: 'https://n8n.ai8mations.com/webhook/sanantonio',
      sarasota: 'https://n8n.ai8mations.com/webhook/sarasota',
      weston: 'https://n8n.ai8mations.com/webhook/weston'
    };

    // Load saved preferences from localStorage
    const savedLocation = localStorage.getItem('selectedLocation') || 'clearwater';
    locationSelect.value = savedLocation;
    const autoDownloadEnabled = localStorage.getItem('autoDownloadEnabled') !== 'false';
    autoDownloadToggle.checked = autoDownloadEnabled;

    // Track if report is being generated
    let isGeneratingReport = false;


    locationSelect.addEventListener('change', () => {
      localStorage.setItem('selectedLocation', locationSelect.value);
    });

    autoDownloadToggle.addEventListener('change', () => {
      localStorage.setItem('autoDownloadEnabled', autoDownloadToggle.checked);
    });

    // --- BEFORE UNLOAD WARNING ---
    window.addEventListener('beforeunload', function(e) {
      if (isGeneratingReport) {
        e.preventDefault();
        e.returnValue = 'A report is currently being generated. You will lose your session if you close/refresh your browser.';
        return e.returnValue;
      }
    });



    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorEl.textContent = '';
      statusEl.textContent = '';
      // Hide download button if it exists
      const existingDownloadBtn = document.getElementById('downloadBtn');
      if (existingDownloadBtn) existingDownloadBtn.style.display = 'none';

      // Get and clean input
      const rawInput = textarea.value.trim();
      if (!rawInput) {
        errorEl.textContent = 'Please enter at least one permit number.';
        return;
      }

      // Split by new lines
      const permits = rawInput.split(/\r?\n/).map(line => line.trim()).filter(Boolean);

      // Start report generation
      isGeneratingReport = true;

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Generating Report...';

      // Show enhanced status with spinner
      statusEl.className = 'processing';
      statusEl.innerHTML = '<span class="spinner"></span>Submitting permits…';

      try {
        // Get the selected webhook URL
        const selectedLocation = locationSelect.value;
        const webhookURL = webhookURLs[selectedLocation];

        // Call the webhook
        const url = `${webhookURL}?permitNumbers=${encodeURIComponent(permits.join('\n'))}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Workflow request failed.');

        statusEl.innerHTML = '<span class="spinner"></span>Processing permits… please wait.';

        // Expect CSV file as response
        const blob = await response.blob();

        if (autoDownloadToggle.checked) {
          // Auto-download the CSV file
          const downloadUrl = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = 'permit_report_clearwater.csv';
          a.click();
          URL.revokeObjectURL(downloadUrl);
          statusEl.className = '';
          statusEl.textContent = 'Report downloaded successfully.';
        } else {
          // Show download button
          let downloadBtn = document.getElementById('downloadBtn');
          if (!downloadBtn) {
            downloadBtn = document.createElement('button');
            downloadBtn.id = 'downloadBtn';
            downloadBtn.textContent = 'Download CSV';
            downloadBtn.style.cssText = `
              margin-top: 15px;
              padding: 10px 20px;
              background-color: #28a745;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            `;
            downloadBtn.addEventListener('click', () => {
              const downloadUrl = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = downloadUrl;
              a.download = 'permit_report_latest.csv';
              a.click();
              URL.revokeObjectURL(downloadUrl);
              downloadBtn.style.display = 'none';
              statusEl.textContent = 'Report downloaded successfully.';
            });
            statusEl.parentNode.insertBefore(downloadBtn, statusEl.nextSibling);
          }
          downloadBtn.style.display = 'inline-block';
          statusEl.className = '';
          statusEl.textContent = 'Report ready. Click below to download.';
        }
      } catch (err) {
        console.error(err);
        errorEl.textContent = 'Error: ' + err.message;
        statusEl.className = '';
        statusEl.textContent = '';
      } finally {
        // Report generation complete (success or error)
        isGeneratingReport = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generate CSV Report';
      }
    });
  </script>
</body>
</html>
